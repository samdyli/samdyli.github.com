---
layout: post
title: QCon全球软件开发大会-声明式自愈系统——高可用分布式系统的设计之道总结
---



# {{page.title}}

有幸在2019年5月7日参加QCon北京2019全球软件大会，在大会上，阿里巴巴高级专家王昕介绍了声明式自愈系统在分布式领域的应用。以下为根据实际内容总结，如有侵权请联系samdyli@yeah.net进行删除。 



## 一、分布式系统理论（为什么需要声明式自愈系统?）

### 1.1 无状态节点和有状态阶段

单体应用的时代，从代码到数据都是**ALL IN ONE**的结构。随着系统压力的增加， 最开始我们可以通过换一个更快CPU和更大的内容提升系统的容量。随着用户规模的进一步增长， 我们把系统进行水平扩展和垂直扩展。这变成了一个分布式环境下的系统。



分布式环境下的软件设计比单机应用面临更多的挑战。比如在随时可能失败的环境下，如何保障分布式条件下数据一致性。如何在分布式系统中保证事务特性等。前人提出很多分布式理论和算法。本文主要关注分布式系统高可用性问题。

一个计算或者存储节点，我们系统节点不带有任何状态。一个无状态的节点具有如下特性：

(1) 随机选择：可以随机选择任何一个节点进行通信。

(2) 不必处理数据复制和同步问题：因为没有状态，也不会存在谁的数据更新的问题。

(3) 容量和可用性同步提升：由于节点直接不需要同步状态信息。随着节点的增加，计算和存储能力增强。系统可用性也随之增强。

(4) 节点可以随意迁移，不必固定Ip和存储。

无状态的节点，可以很容易的实现高可用。但是，实现一个真正无状态的节点确实很难。现实大多数情况下， 节点都是具有状态信息的。

对于有状态分布式系统实现高可用面临很多困难。表现在：

(1) 特定节点处理请求

(2) 需要考虑数据备份和同步

(3) 容量和高可用需要不同解决方案

(4) 服务节点不能随便迁移

### 1.2 CAP理论

针对有状态分布式系统，已经很很多成熟的理论和算法被提了出来。

最著名的就是**CAP理论**。CAP理论即一致性(Consistency)、高可用(Availability )、分区(Partition )三个特性只能满足两个。

在分布式架构下，**CAP理论**并非在高可用和一致性中非黑即白选择其中一个。理由如下：

(1) 只有“在分区存在的前提下呈现完美的数据一致性和可用性”这种很少见的情况是CAP理论不允许出现的。

(2) 分区也并非频繁出现， 很多时间都只是在执行特定操作才会出现分区。

(3) 高可用和一致性不是非0即1的选择， 可以选择不同程度的高可用(0%-100%)和一致性(严格一致性和最终一致性)

更多关于**CAP理论**的解释，详见[**CAP理论十二年回顾："规则"变了中文版本**](<https://cloud.tencent.com/developer/article/1033206>)。

可用性和一致性之间不同选择产生了不同的算法，如下图：

![1557238450274](C:\Users\gexch\AppData\Roaming\Typora\typora-user-images\1557238450274.png)



### 1.3 为什么需要自愈？
正如上文所述，**CAP理论** 不是2选3的理论。分布式系统根据不同的业务场景选择不同程度的高可用和一致性。下图我们根据不同的服务等级(**SLA**)选择不同的可用性，我们为系统赋予不同的自愈程度选怎不同的一致性。

![1557316235255](C:\Users\gexch\AppData\Roaming\Typora\typora-user-images\1557316235255.png)

### 1.4 安全性和活性
安全性即Something bad will never happen。活性即Something good will eventually happen。

## 2 何为声明式自愈系统？

### 2.1 何为声明式？
与声明式相对应的是命令式。两者是不同的编程范式，命令式编程关心怎么做(**How**)，然后我们按照执行步骤书写代码。而声明式更多关心做什么(**What**)。

Function Vs State Machine

声明式编程更关心现在所处于的状态，因此对状态机更关心些。 命令式编程关心Function。











Reference:

[**CAP理论十二年回顾："规则"变了英文版本**](<https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed>)

[**CAP理论十二年回顾："规则"变了中文版本**](<https://cloud.tencent.com/developer/article/1033206>)



